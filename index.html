<!DOCTYPE html>
<html>
<head>
  <title>Map Connections</title>
  <script src="https://maps.googleapis.com/maps/api/js"></script>
  <script>
  var ws = new WebSocket('ws://localhost:8080/');
  var excludeIpRegex = /(^127\.0\.0\.1)|(^10\.)|(^224\.)|(^172\.1[6-9]\.)|(^172\.2[0-9]\.)|(^172\.3[0-1]\.)|(^192\.168\.)/g;
  var extractIpRegex = /SRC=(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}) DST=(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})/g;

  var map;
  function log(msg) {
    var logElement = document.getElementById('log');
    console.log(msg);
    var match = extractIpRegex.exec(msg);
    if (match != null) {
      //  logElement.textContent = '\n' + logElement.textContent;
      for (var i = 1 ; i < match.length;i++) {
        //logElement.textContent = ' ' + match[i] + logElement.textContent;
        geoip(match[i]);
      }
    }
  }
  function geoipCallback(data) {
    console.log(JSON.stringify(data));
    var point = new google.maps.LatLng(data.latitude, data.longitude);
    var marker = new google.maps.Marker({
      position: point,
      title: data.country + ' ' + data.isp + ' ' + data.ip,
      animation: google.maps.Animation.DROP,
      map: map
    });
  }
  function geoip(ip) {
    if (excludeIpRegex.test(ip)) {
      console.log("Exclude IP: " + ip);
      return;
    }
    var script = document.createElement('script');
    script.src = 'http://www.telize.com/geoip/'+ip+'?callback=geoipCallback';
    document.head.appendChild(script);
  }

  ws.onopen = function() {
    console.log("Websocket opened.");
  };

  ws.onclose = function() {
    console.log("Websocket closed.");
  };

  ws.onmessage = function(event) {
    log(event.data);
  };
  function initialize() {
    var mapCanvas = document.getElementById('map-canvas');
    var mapOptions = {
      center: new google.maps.LatLng(44.5403, -78.5463),
      zoom: 3,
      mapTypeId: google.maps.MapTypeId.ROADMAP
    }
    map = new google.maps.Map(mapCanvas, mapOptions);
  }
  google.maps.event.addDomListener(window, 'load', initialize);
  </script>
  <style>
  #map-canvas {
    height: 100%;
    width: 100%;
    left: 0;
    position: absolute;
    top: 0;
  }
  </style>

</head>
<body>
  <pre id="log"></pre>
  <div id="map-canvas"></div>
</body>
</html>
